# Post-Test Issue Report (Parts 1-4)

**Date:** Feb 17, 2026
**Tests Analyzed:** 1-12 (Foundation, Core Logging, Ambiguity)
**Status:** ðŸš¨ CRITICAL ISSUES FOUND

## Executive Summary
Analysis of the manual test flow and system logs reveals **two critical system failures** and **two major logic flaws** that undermine the core value proposition of the app.
1.  **Persistence/Context Failure**: The "Brain" (ReasoningAgent) is disconnected from the "Body" (Database). It forgets health constraints and goals between sessions, leading to dangerous safety failures (missing allergen warnings).
2.  **UX Breakdown**: The "Log Food" modal fails to appear reliably, breaking the primary loop.

---

## Issue 1: The "Amnesia" Bug (Critical Safety Failure)

### Symptoms
-   **Test 4**: User adds health constraints -> System confirms -> Next chat check: "I don't have any recorded health constraints."
-   **Test 12**: User logs "Cheddar Cheese" -> System fails to warn about Lactose Intolerance (defined in Test 3).
-   **Test 1**: Bot confirms goal update to 80g Fat, but Dashboard/Verify checks show old values.

### Core Root Cause
**Context Hydration Failure in Orchestrator.**
The `ReasoningAgent` relies on `context.healthConstraints` and `context.userProfile` being passed into its constructor. The logs imply this context is **empty** or **stale** at the start of a new turn/session.
-   When `ReasoningAgent` calls `ask_nutrition_agent`, it passes this empty `healthConstraints` array.
-   The `NutritionAgent` prompt explicitly says: *"Flag CRITICAL health conflicts... ONLY if relevant to constraints"*.
-   Since the agent sees *zero* constraints, it returns *zero* flags, even for obvious allergens like Dairy in Cheese.

### Fix Plan
1.  **Audit `OrchestratorV3.ts`**: Verify exactly how `healthConstraints` and `userProfile` are fetched before the agent loop starts.
2.  **Force Refresh**: Ensure `ToolExecutor` reads from the DB *live* for critical checks if the context is suspected to be stale, or implement a "Context Refresh" step at the start of `ReasoningAgent` execution.
3.  **Debug Logging**: Add explicit logs in `ReasoningAgent` startup: `[Context] Loaded N health constraints`.

---

## Issue 2: The "Invisible Modal" (Critical UX Failure)

### Symptoms
-   **Test 6**: "I've prepared the log... Please confirm" -> User sees text but **no modal**.
-   **Test 11**: Same behavior for "Large Carbonara".

### Core Root Cause
**Frontend Event Handling Mismatch.**
The `ReasoningAgent` logic contains a specific block for "batching" or explicitly constructing the proposal object.
-   If the `proposal_type` or `proposal_id` format sent by the backend doesn't *exactly* match what the Frontend Event Listener expects, user interaction is blocked.
-   *Hypothesis*: The frontend might be listening for a specific event event name, but the `Chat-Handler` is streaming it as a generic "Log" or "Tool Result" chunk that isn't parsed into a trigger.

### Fix Plan
1.  **Standardize Event Emission**: Ensure `propose_food_log` *always* emits a distinct `UI_TRIGGER` event (or similar) that the frontend is guaranteed to catch.
2.  **Frontend Debug**: Check the `useEffect` or stream parser in the frontend code that listens for `proposal_type: 'food_log'` and ensure it handles the `batch_` ID format generated by the agent.

---

## Issue 3: Nutrition Logic & Brand Context

### Symptoms
-   **Test 5 (Eggs)**: Logged "2 boiled eggs" -> System logged "1 serving" of "Large egg, Boiled". Macros were correct for 2 eggs, but the *Label* was confusing.
-   **Test 7 (Whey)**: System assumed "Dry Scoop" (powder only) without asking for mixer (water/milk).

### Core Root Cause
1.  **Normalization Over-Aggression**: The `NutritionAgent` normalizes "2 boiled eggs" to a standard database item "Large Egg". It correctly calculating the *macros* (2x), but assigned the *generic name* "Large Egg" and "1 serving" (as in "1 meal entry") rather than "2 servings".
2.  **Context Laziness**: The `ReasoningAgent` is biased towards "Efficiency" (fewest turns). It didn't trigger a clarification question for the Whey mixer because "Whey Protein" is a valid food item on its own, unlike "Sandwich" which implies components.

### Fix Plan
1.  **Refine Normalization**: Update `NutritionAgent` to preserve the user's *quantity* in the `portion` field (e.g., "2 items") rather than collapsing it to "1 serving".
2.  **Heuristic Checks**: Add a logic rule for "Powders/Concentrates": *If food is a powder (protein, collagen, flour), explicitly ask "Did you mix this with anything?" unless context is provided.*

---

## Issue 4: Goal & Dashboard Drift

### Symptoms
-   **Test 1**: Bot says "Updated fat to 80g". Dashboard shows "200g".
-   **Test 7**: Bot warns "exceeding target" (3340 vs 2400), but Dashboard shows 1670.

### Core Root Cause
**Source of Truth Conflict.**
-   The **Bot** calculates "Today's Progress" by summing logs *dynamically* via `get_today_progress`.
-   The **Dashboard** likely relies on a `daily_summaries` table or a different aggregation query.
-   If the Bot includes "Pending/Proposed" logs in its "Current Intake" calculation (double counting prediction), it triggers false warnings.

### Fix Plan
1.  **Verify Aggregation**: Check `get_today_progress` tool implementation. Ensure it *excludes* the current pending proposal when calculating "current status".
2.  **Unified Sync**: Ensure `update_user_goals` writes to the *exact* user metadata table that the Dashboard reads from.

---

## Summary of Next Steps

1.  **IMMEDIATE**: Fix **Issue 1 (Persistence)**. The app is unsafe without it.
2.  **HIGH**: Fix **Issue 2 (Modal)**. The app is unusable without it.
3.  **MEDIUM**: Refine Nutrition Logic (Issue 3).
4.  **LOW**: Debug Dashboard Sync (Issue 4).
